<!DOCTYPE>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
         <meta http-equiv="Content-type" content="text/html; charset=utf-8">
         <meta name="apple-mobile-web-app-capable" content="yes">
         <link rel="stylesheet" href="jquery.mobile-1.0rc1.min.css" />
         <script src="phonegap-1.0.0.js" />
         <script src="jquery-1.6.4.min.js"></script>
         <script src="jquery.mobile-1.0rc1.min.js"></script>
         <script src="mustache.js" type="text/javascript"></script>
         <script src="underscore-min.js" type="text/javascript"></script>
    </head>
	<body>
		<div data-role="page">
			<div data-role="header">
				<h1>Kontaktliste<h1>
            </div>
			<div data-role="content">
				<form action="#" id="new-contact-form" data-ajax="false">
					<div data-role="fieldcontain">
						<label for="name">Navn:</label>
						<input type="text" id="name" />
					</div>
					<div data-role="fieldcontain">
						<label for="number">Tlf.nr</label>
						<input type="number" id="number" />
					</div>
					<div data-role="fieldcontain">
                        <input type="checkbox" id="kontaktliste" class="custom" />
						<label for="kontaktliste">Lagre i kontaktliste</label>
					</div>
					<div data-role="fieldcontain">
						<input type="submit" value="Lagre" />
					</div>
				</form>
				<div style="clear:both; height:10px;"></div>
				<ul id="contact-list" data-role="listview">
				</ul>
			</div>
			<script>
				$(function(){
                  window.App = {
                  	contactTemplate: "<li><a href='#'><h1>{{name}}</h1><p>{{number}}</p></a></li>",
                  	data: function(){
                  		var store = localStorage.getItem('contacts');
                  		return (store && JSON.parse(store)) || {};
                  },
				lagreKontaktLista: function(navn, nummer, kontaktliste) {

                  var contact = navigator.contacts.create();
                  contact.displayName = navn;
                  contact.nickname = navn;
					
                  var tlfNummere = [1];
  				  tlfNummere[0] = new ContactField('mobile', nummer, true);
				  contact.phoneNumbers = tlfNummere;
					
				  var name = new ContactName();
				  name.formatted = navn;
                  name.givenName = navn;
				  contact.name = name;
                  
				  contact.save(onSuccess, onError);

				  function onSuccess() {
			   	      navigator.notification.alert('Kontakten ble lagret i adresseboka', null, 'Suksess');
		          }

				  function onError(contactError) {
						navigator.notification.alert('Feilkode: ' + contactError.code, null, 'En feil inntraff');
				  }	
				},
                addContact: function(name, number){
                  	var data = this.data();
                  	data[number] = {name: name, number: number};
                  	localStorage.setItem('contacts', JSON.stringify(data));
                  	this.render();
                  },
                  allContacts: function(){
                  	return _.values(this.data());
                  },
                  render: function(){
                  	if (false){
                  		localStorage.setItem("contacts", JSON.stringify({}));
                  	}
                  	var html = _.reduce(this.allContacts(), function(memo, contact){
                                      return memo + Mustache.to_html(App.contactTemplate, contact);
                                      }, "");
                  	$("#contact-list").html(html).listview("refresh");
                  }
                };
                $("#new-contact-form").live("submit", function(e) {
	            	App.addContact($("#name").val(), $("#number").val());
                    if ($("#kontaktliste").is(":checked")) {
                    	App.lagreKontaktLista($("#name").val(), $("#number").val());
                    }
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                  });
                  App.render();
                  });
                </script>
		</div>
	</body>
</html> 