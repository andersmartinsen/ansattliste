<!DOCTYPE html>
<html>
	<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="jquery.mobile-1.0rc1.min.css">
    <script src="phonegap-1.0.0.js"></script>
    <script src="jquery-1.6.4.min.js"></script>
    <script src="jquery.mobile-1.0rc1.min.js"></script>
    <script src="mustache.js" type="text/javascript"></script>
    <script src="underscore-min.js" type="text/javascript"></script>
    <title>Ansattliste</title>
  </head>
	<body>
		<div data-role="page" id="main-page">
			<div data-role="header">
				<h1>Kontaktliste</h1>
        <a href="#add-contact-page" data-rel="dialog" class="ui-btn-right" data-icon="plus" data-transition="slidedown">Ny</a>
      </div>
			<div data-role="content">
				<ul id="contact-list" data-role="listview">
				</ul>
		  </div>
    </div>
    <div data-role="page" data-theme="c" id="add-contact-page" data-add-back-btn="true">
      <div data-role="header">
        <h1>Legg til ny kontakt</h1>
      </div>
      <div data-role="content">
        <form action="#" id="new-contact-form" data-ajax="false">
          <div data-role="fieldcontain">
            <input type="text" id="name" placeholder="Navn" />
          </div>
          <div data-role="fieldcontain">
            <input type="number" id="number" placeholder="Telefonnummer" />
          </div>
          <div data-role="fieldcontain">
            <label for="kontaktliste">Lagre p√• telefonen</label>
            <input type="checkbox" id="kontaktliste" class="custom" />
          </div>
          <input type="submit" value="Lagre" />
        </form>
      </div>
    </div>     
  <script>
  	$(function(){
     // Hei
      window.App = {
        contactTemplate: "<li><a href='#'><h1>{{name}}</h1><p>{{number}}</p></a></li>",
        data: function(){
        	var store = localStorage.getItem('contacts');
        	return (store && JSON.parse(store)) || {};
        },
        lagreKontaktLista: function(navn, nummer, kontaktliste) {
          var contact = navigator.contacts.create();
          contact.displayName = navn;
          contact.nickname = navn;

          var tlfNummere = [1];
          tlfNummere[0] = new ContactField('mobile', nummer, true);
          contact.phoneNumbers = tlfNummere;

          var name = new ContactName();
          name.formatted = navn;
          name.givenName = navn;
          contact.name = name;
          contact.save(onSuccess, onError);

  			  function onSuccess() {
  		   	      navigator.notification.alert('Kontakten ble lagret i adresseboka', null, 'Suksess');
  	      }

  			  function onError(contactError) {
  					navigator.notification.alert('Feilkode: ' + contactError.code, null, 'En feil inntraff');
  			  }	
  			},
        addContact: function(name, number){
          	var data = this.data();
          	data[number] = {name: name, number: number};
          	localStorage.setItem('contacts', JSON.stringify(data));
          	this.render();
          },
        allContacts: function(){
        	return _.values(this.data());
        },
        render: function(){
        	if (false){
        		localStorage.setItem("contacts", JSON.stringify({}));
        	}
        	var html = _.reduce(this.allContacts(), function(memo, contact){
                        return memo + Mustache.to_html(App.contactTemplate, contact);
                        }, "");
        	$("#contact-list").html(html).listview("refresh");
        }
      };
      $("#new-contact-form").live("submit", function(e) {
        var name = $("#name").val();
        $("#name").val("");
        var number = $("#number").val();
        $("#number").val("");
    	  App.addContact(name, number);
        if ($("#kontaktliste").is(":checked")) {
        	App.lagreKontaktLista(name, number);
        }
        e.preventDefault();
        e.stopPropagation();
        $.mobile.changePage($("#main-page"), {transition: "none"});
        return false;
      });
      App.render();
    });
  </script>
	</body>
</html> 